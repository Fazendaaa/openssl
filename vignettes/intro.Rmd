---
title: "The openssl package: a modern R interface to OpenSSL"
date: "`r Sys.Date()`"
output:
  html_document
vignette: >
  %\VignetteIndexEntry{The openssl package: a modern R interface to OpenSSL}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(openssl)
```

The `openssl` package implements a modern interface to libssl and libcrypto for R. It builds on the new `EVP` api which was introduced in OpenSSL 1.0 and provides a unified API to the various methods and formats. OpenSSL supports three major public key crypto systems:

 - __RSA__ : Most popular method. Supports both encryption and signatures.
 - __DSA__ : Digital Signature Algorithm. Mostly for signatures, not very popular anymore.
 - __ECDSA__ : Elliptic Curve DSA. Supports signatures and encryption via Diffie Hellman. Gaining popularity.

|    | RSA | DSA | ECDSA | Secret Key |
|-------:|:---:|:---:|:----:|:---------:|
| load private key | `read_key` | `read_key`  | `read_key`  | - |
| load public / ssh key | `read_pubkey` | `read_pubkey`  | `read_pubkey`  | - | 
| generate new key  | `rsa_keygen` | `dsa_keygen` | `ec_keygen` | `rand_bytes` |
| authentication | `signature_create` | `signature_create` | `signature_create` | `hmac` |
| encrypt secret | `rsa_encrypt` | - | - | - |
| encrypt large data | `encrypt_envelope` | - | - | `aes_cbc` |
| diffie hellman | - | - | `ec_diffie` | - |
| save private key | `write_pem` | `write_pem` | `write_pem`  ||
| save pubkey | `write_{pem,ssh}` | `write_{pem,ssh}` | `write_{pem,ssh}`  ||

## Key / Certificate Formats

For each type there are three common __formats__ for storing keys and certificates: 

 - [__DER__](#the-der-format): binary format, serialized ASN.1 structure
 - [__PEM__](#the-pem-format): base64 encoded DER + header wrapped in `===`
 - [__SSH__](#the-openssh-format): single line of base64 with a header. Only for pubkeys.
 
The openssl package automatically detects the format when possible. However being able to recognize the various formats can be useful.

### The DER format

DER is the standard __binary__ format using by protocols for storing and exchanging keys and certificates. It consists of a [serialized ASN.1](https://en.wikipedia.org/wiki/Abstract_Syntax_Notation_One#Example_encoded_in_DER) structure which hold the key's (very large) prime numbers.


```{r}
key <- ec_keygen()
pubkey <- as.list(key)$pubkey
write_der(pubkey)
```

Users typically don't need to worry about the key's underlying primes, but have a look at `as.list(key)` if you are curious.

### The PEM format

In practice the user will rarely encounter DER because it is mainly for internal use. When humans exchange keys and certificates they typically use the PEM format. PEM is simply **base64 encoded DER data, plus a header** that identifies the type of data. You have probably seen it:

```{r}
cat(write_pem(pubkey))
cat(write_pem(key, password = NULL))
```

The PEM format allows for protecting private keys with a password. R will prompt you for the password when reading such a protected key.

```{r}
cat(write_pem(key, password = "supersecret"))
```

### The OpenSSH format

For better or worse, OpenSSH uses a custom format for **public keys**. The advantage of this format is that it fits on a single line which is nice for e.g. your `~/.ssh/known_hosts` file. There is no special format for private keys, OpenSSH uses PEM as well.

```{r}
write_ssh(pubkey)
```

The `read_pubkey` function will automatically detect if a file contains a `PEM` or `SSH` key.


## Methods: RSA, DSA, ECDSA





OpenSSL supports the common cryptograhpic methods RSA, DSA and ECDSA. Another popular method is curve25519 which is currently not available in OpenSSL but available in the [sodium](https://cran.r-project.org/web/packages/sodium/vignettes/intro.html) package. Of these three, RSA is the most widely used because it has been around for a long time and supports both encryption and digital signatures which is very nice. 

More recently ECDSA has gained popularity because it is simpler and more efficient than RSA. Even though ECDSA is primarely a digital signature algorithm, encryption can be accomplished relatively easily via EC diffie-hellman. DSA has mostly gone out of fashion, but is still considered secure and  used in some places for digital signatures.

### Loading a key

### Creating a Digital Signature

```{r}
write_ssh(pubkey)
```


